<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>BAGDigital.tech — Cubing Toolkit</title>
  <meta name="description" content="Bright, no-scroll cubing toolkit: multi-event scrambles, big timer, Ao5/Ao12, share card, and a visual solve replay." />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

  <script type="module">
    import 'https://unpkg.com/@material/web/all.js?module';
  </script>

  <style>
    :root{
      --b:#0057FF; --r:#E61B23; --y:#FFD400; --g:#00B050; --o:#FF6A00;
      --bg:#F3F7FF; --surface:#FFFFFF; --ink:#0B1220; --muted:#4C5A73;
      --line: rgba(11,18,32,.10); --brand:#1a73e8; --brandInk:#0b2a55;
      --e1: 0 1px 2px rgba(16,24,40,.06), 0 1px 3px rgba(16,24,40,.05);
      --e2: 0 10px 22px rgba(16,24,40,.10);
      --r16:16px; --r20:20px; --r24:24px;
      --t: 160ms; --ease: cubic-bezier(.2,.8,.2,1);
      font-family: Roboto, system-ui, -apple-system, Segoe UI, Helvetica, Arial;
      color-scheme: light;

      --md-sys-color-primary: var(--brand);
      --md-sys-color-on-primary: #ffffff;
      --md-sys-color-surface: var(--surface);
      --md-sys-color-on-surface: var(--ink);
      --md-sys-color-outline: rgba(11,18,32,.16);

      --md-filled-button-container-shape: 999px;
      --md-outlined-button-container-shape: 999px;
      --md-outlined-text-field-container-shape: 14px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 680px at 6% -10%, rgba(0,87,255,.14), transparent 60%),
        radial-gradient(1000px 620px at 96% 0%, rgba(230,27,35,.10), transparent 58%),
        radial-gradient(1100px 700px at 70% 110%, rgba(255,212,0,.12), transparent 60%),
        radial-gradient(1000px 680px at 12% 110%, rgba(0,176,80,.10), transparent 60%),
        var(--bg);
      color: var(--ink);
      overflow: hidden;
    }

    .app{ height:100svh; display:grid; grid-template-rows:auto 1fr; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px;
      background: rgba(255,255,255,.80);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .brand{ display:flex; align-items:center; gap:10px; text-decoration:none; min-width:0; }
    .logo{
      width:34px; height:34px; border-radius:12px;
      background: conic-gradient(from 180deg, var(--b), var(--r), var(--y), var(--g), var(--o), var(--b));
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.82), var(--e1);
      flex:0 0 auto;
      transition: transform var(--t) var(--ease);
    }
    .brand:hover .logo{ transform: rotate(6deg) scale(1.03); }
    .brandText{ min-width:0; display:flex; flex-direction:column; line-height:1.05; }
    .brandText strong{
      font-weight:900; letter-spacing:.2px; color:var(--brandInk);
      font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brandText span{
      font-size:12px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .topActions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .grid{
      height:100%;
      padding:12px;
      display:grid;
      gap:12px;
      grid-template-columns: 1fr 1.4fr 1fr;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; grid-template-rows: 1fr 1.15fr 1fr; }
    }

    .panel{
      border: 1px solid var(--line);
      border-radius: var(--r24);
      background: rgba(255,255,255,.92);
      box-shadow: var(--e2);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    .head{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(180deg, rgba(26,115,232,.06), rgba(255,255,255,0));
    }
    .head h2{
      margin:0;
      font-size:12px;
      letter-spacing:.8px;
      text-transform:uppercase;
      color:var(--brandInk);
      font-weight:900;
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background: var(--b);
      box-shadow: 0 0 0 4px rgba(0,87,255,.14);
    }
    .body{ padding:12px; display:flex; flex-direction:column; gap:10px; min-height:0; }

    /* Native select styled like Material */
    .selectWrap{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end; }
    .selectLabel{ font-size:12px; font-weight:900; color:var(--muted); margin:0 0 6px 2px; }
    select{
      width:100%;
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(11,18,32,.16);
      background:#fff;
      box-shadow: var(--e1);
      padding: 0 12px;
      font: 800 14px/1 Roboto, system-ui;
      color: rgba(11,18,32,.90);
      outline:none;
      appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(11,18,32,.55) 50%),
        linear-gradient(135deg, rgba(11,18,32,.55) 50%, transparent 50%),
        linear-gradient(to right, transparent, transparent);
      background-position:
        calc(100% - 18px) 18px,
        calc(100% - 12px) 18px,
        calc(100% - 2.5em) 0.5em;
      background-size: 6px 6px, 6px 6px, 1px 1.5em;
      background-repeat: no-repeat;
    }

    .scramble{
      border: 1px dashed rgba(0,87,255,.36);
      background: rgba(0,87,255,.06);
      border-radius: var(--r20);
      padding: 12px;
      box-shadow: var(--e1);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-weight: 900;
      font-size: 16px;
      line-height: 1.55;
      min-height: 70px;
      display:flex;
      align-items:center;
      color: rgba(11,18,32,.92);
      word-break: break-word;
    }

    .actionsRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .hintPill{
      font-size:12px; font-weight:900;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(11,18,32,.12);
      background:#fff;
      box-shadow: var(--e1);
      color: rgba(11,18,32,.84);
      white-space: nowrap;
    }

    .timerBox{
      border: 1px solid rgba(230,27,35,.14);
      background:
        radial-gradient(900px 260px at 50% -40%, rgba(230,27,35,.10), transparent 70%),
        radial-gradient(900px 260px at 50% 140%, rgba(0,87,255,.10), transparent 70%),
        rgba(246,248,252,.92);
      border-radius: var(--r24);
      padding: 12px;
      box-shadow: var(--e1);
      display:flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
    }
    .timerHint{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      background:#fff;
      border: 1px solid rgba(11,18,32,.12);
      padding: 2px 8px;
      border-radius: 999px;
      box-shadow: var(--e1);
      color: rgba(11,18,32,.80);
      font-weight: 900;
    }
    .time{
      text-align:center;
      font-variant-numeric: tabular-nums;
      font-weight: 900;
      font-size: clamp(62px, 6.8vw, 104px);
      letter-spacing: -1px;
      color: var(--brandInk);
      line-height:1.05;
      user-select:none;
    }
    .status{
      align-self:center;
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(11,18,32,.12);
      background:#fff;
      box-shadow: var(--e1);
      font-size: 12px;
      font-weight: 900;
      color: rgba(11,18,32,.86);
      user-select:none;
    }
    .status .sdot{
      width:10px; height:10px; border-radius:50%;
      background: var(--b);
      box-shadow: 0 0 0 4px rgba(0,87,255,.14);
      transition: background var(--t) var(--ease), box-shadow var(--t) var(--ease);
    }

    .statsRow{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    md-outlined-text-field{ width:100%; }

    .solves{
      border: 1px solid rgba(11,18,32,.10);
      background:#fff;
      border-radius: var(--r20);
      box-shadow: var(--e1);
      overflow:hidden;
      display:flex;
      flex-direction: column;
    }
    .solvesHead{
      padding: 8px 10px;
      background: rgba(0,87,255,.06);
      border-bottom: 1px solid rgba(11,18,32,.08);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .solvesHead b{
      font-size:11px; text-transform:uppercase; letter-spacing:.75px;
      font-weight:900; color: rgba(85,96,116,.98);
    }
    .chips{
      padding: 8px 10px;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      align-content:start;
    }
    .chip{
      border: 1px solid rgba(11,18,32,.10);
      background: rgba(249,251,255,.96);
      border-radius: 14px;
      padding: 8px;
      box-shadow: var(--e1);
      text-align:center;
      line-height:1.1;
    }
    .chip .n{ display:block; font-size:10px; font-weight:900; color: rgba(85,96,116,.95); margin-bottom:3px; }
    .chip .t{ display:block; font-weight:900; color: rgba(11,18,32,.90); font-variant-numeric: tabular-nums; }

    /* Visual solver: ensure it has HEIGHT */
    .vizHint{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .vizBox{
      border:1px solid rgba(11,18,32,.10);
      background:#fff;
      border-radius: var(--r24);
      box-shadow: var(--e1);
      overflow:hidden;
      padding: 10px;
      height: 360px;          /* critical: ensures player is visible */
      display:flex;
      align-items:center;
      justify-content:center;
    }
    twisty-player{
      width: 100%;
      height: 100%;
      max-width: 420px;
      border-radius: 18px;
    }

    /* Decorative CSS cube (kept, but now not the only “solver”) */
    .cssCubeWrap{ display:flex; justify-content:center; padding-top: 6px; }
    .cube3d{
      width: 64px; height: 64px; position: relative;
      transform-style: preserve-3d;
      transform: rotateX(-22deg) rotateY(35deg);
      animation: cubeSpin 3.2s var(--ease) infinite;
    }
    @keyframes cubeSpin{
      0%{ transform: rotateX(-22deg) rotateY(35deg); }
      100%{ transform: rotateX(-22deg) rotateY(395deg); }
    }
    .face{ position:absolute; inset:0; border-radius:12px; box-shadow: inset 0 0 0 2px rgba(255,255,255,.65), 0 10px 18px rgba(16,24,40,.14); opacity:.95; }
    .front{ background: var(--b); transform: translateZ(32px); }
    .back{ background: var(--g); transform: rotateY(180deg) translateZ(32px); }
    .right{ background: var(--r); transform: rotateY(90deg) translateZ(32px); }
    .left{ background: var(--o); transform: rotateY(-90deg) translateZ(32px); }
    .top{ background: var(--y); transform: rotateX(90deg) translateZ(32px); }
    .bottom{ background: #fff; transform: rotateX(-90deg) translateZ(32px); }

    md-filled-button, md-outlined-button{ transition: transform var(--t) var(--ease); }
    md-filled-button:hover, md-outlined-button:hover{ transform: translateY(-1px); }
    md-filled-button:active, md-outlined-button:active{ transform: translateY(0); }
  </style>
</head>

<body>
  <div class="app">
    <header class="topbar">
      <a class="brand" href="https://bagdigital.tech" aria-label="BAGDigital.tech home">
        <span class="logo" aria-hidden="true"></span>
        <span class="brandText">
          <strong>BAGDigital.tech</strong>
          <span>Cubing Toolkit — scrambles, timer, and visual solve replay</span>
        </span>
      </a>
      <div class="topActions">
        <md-outlined-button id="copyLinkBtn">Copy link</md-outlined-button>
        <md-filled-button id="openWcaBtn">Official WCA page</md-filled-button>
      </div>
    </header>

    <main class="grid">
      <!-- LEFT -->
      <section class="panel" aria-label="Share">
        <div class="head">
          <h2><span class="dot"></span>Share</h2>
        </div>
        <div class="body">
          <div class="hintPill">Copy → paste to group chat / socials</div>
          <div style="display:flex; gap:10px; align-items:center; border:1px solid rgba(11,18,32,.10); background:#fff; border-radius: var(--r20); padding:10px; box-shadow: var(--e1);">
            <textarea id="promoText" readonly style="width:100%; height: 120px; resize:none; border:1px solid rgba(11,18,32,.12); border-radius:12px; padding:8px 10px; font: 800 13px/1.35 Roboto; color: rgba(11,18,32,.88);"></textarea>
            <md-filled-button id="copyPromoBtn">Copy</md-filled-button>
          </div>
          <div class="hintPill">Built by BAGDigital.tech — web + automation</div>
        </div>
      </section>

      <!-- CENTER -->
      <section class="panel" aria-label="Scramble and timer">
        <div class="head">
          <h2><span class="dot" style="background:var(--r); box-shadow:0 0 0 4px rgba(230,27,35,.12)"></span>Main</h2>
          <md-outlined-button id="clearBtn">Clear</md-outlined-button>
        </div>

        <div class="body">
          <div>
            <div class="selectLabel">Puzzle / Event</div>
            <div class="selectWrap">
              <select id="eventSelect" aria-label="Puzzle/Event"></select>
              <md-outlined-button id="newScrambleBtn">New</md-outlined-button>
            </div>
          </div>

          <div class="scramble" id="scrambleText" aria-live="polite">Loading scrambler…</div>

          <div class="actionsRow">
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <md-outlined-button id="copyScrambleBtn">Copy scramble</md-outlined-button>
              <md-filled-button id="solveReplayBtn">Solve replay</md-filled-button>
            </div>
            <span class="hintPill" id="scrambleStatus">WCA-style practice scramble</span>
          </div>

          <div class="timerBox">
            <div class="timerHint">
              <span><span class="kbd">Hold Space</span> → release to start → press <span class="kbd">Space</span> to stop</span>
              <span>Local-only</span>
            </div>

            <div class="time" id="timeDisplay">0.00</div>

            <div class="status" id="statusPill">
              <span class="sdot" aria-hidden="true"></span>
              <span id="statusText">Ready</span>
            </div>

            <div class="statsRow">
              <md-outlined-text-field id="ao5" label="Ao5" value="—" readonly></md-outlined-text-field>
              <md-outlined-text-field id="ao12" label="Ao12" value="—" readonly></md-outlined-text-field>
            </div>

            <div class="solves" aria-label="Recent solves">
              <div class="solvesHead">
                <b>Recent solves</b>
                <span style="font-size:12px; font-weight:900; color:rgba(85,96,116,.95);">last 10</span>
              </div>
              <div class="chips" id="solvesChips"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="panel" aria-label="Visual solver">
        <div class="head">
          <h2><span class="dot" style="background:var(--g); box-shadow:0 0 0 4px rgba(0,176,80,.12)"></span>Visual solve</h2>
          <md-outlined-button id="playScrambleBtn">Play scramble</md-outlined-button>
        </div>

        <div class="body">
          <div class="vizHint">
            <span class="hintPill">Solve replay = inverse of scramble (always correct)</span>
            <span class="hintPill">Tap once, watch it go</span>
          </div>

          <div class="vizBox" id="vizBox">
            <twisty-player id="player" background="none" control-panel="none" hint-facelets="auto"></twisty-player>
          </div>

          <div style="text-align:center; color:var(--muted); font-weight:900; font-size:12px;">CSS cube reference (decorative)</div>
          <div class="cssCubeWrap" aria-hidden="true">
            <div class="cube3d">
              <div class="face front"></div><div class="face back"></div>
              <div class="face right"></div><div class="face left"></div>
              <div class="face top"></div><div class="face bottom"></div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script type="module">
    import "https://cdn.cubing.net/v0/js/cubing/twisty";
    import { randomScrambleForEvent } from "https://cdn.cubing.net/v0/js/cubing/scramble";
    // cubing.net docs show these CDN imports and usage patterns. :contentReference[oaicite:2]{index=2}

    async function copyToClipboard(text){
      try{ await navigator.clipboard.writeText(text); return true; }
      catch(e){
        const ta=document.createElement('textarea'); ta.value=text;
        document.body.appendChild(ta); ta.select();
        const ok=document.execCommand('copy');
        document.body.removeChild(ta); return ok;
      }
    }

    // Top actions
    document.getElementById('openWcaBtn').addEventListener('click', () => {
      window.open('https://www.worldcubeassociation.org/competitions/GeorgiaChampionship2026', '_blank', 'noopener,noreferrer');
    });
    document.getElementById('copyLinkBtn').addEventListener('click', async () => {
      const ok = await copyToClipboard(location.href);
      alert(ok ? 'Link copied.' : 'Could not copy link.');
    });

    // Share text
    const promoText = [
      "Cubing Toolkit (free): multi-event scrambles + big timer + Ao5/Ao12 + visual solve replay.",
      "Readable, bright, and usable at a competition—no sign-in.",
      "Official event info: https://www.worldcubeassociation.org/competitions/GeorgiaChampionship2026",
      location.href
    ].join('\\n');
    document.getElementById('promoText').value = promoText;
    document.getElementById('copyPromoBtn').addEventListener('click', async () => {
      const ok = await copyToClipboard(promoText);
      alert(ok ? 'Share text copied.' : 'Could not copy.');
    });

    // Event list (scramble event id -> twisty puzzle name)
    const EVENTS = [
      { event:"333",   label:"3×3×3",          puzzle:"3x3x3" },
      { event:"222",   label:"2×2×2",          puzzle:"2x2x2" },
      { event:"444",   label:"4×4×4",          puzzle:"4x4x4" },
      { event:"555",   label:"5×5×5",          puzzle:"5x5x5" },
      { event:"666",   label:"6×6×6",          puzzle:"6x6x6" },
      { event:"777",   label:"7×7×7",          puzzle:"7x7x7" },
      { event:"333oh", label:"3×3 One-Handed", puzzle:"3x3x3" },
      { event:"pyram", label:"Pyraminx",       puzzle:"pyraminx" },
      { event:"skewb", label:"Skewb",          puzzle:"skewb" },
      { event:"minx",  label:"Megaminx",       puzzle:"megaminx" },
      { event:"sq1",   label:"Square-1",       puzzle:"square1" },
      { event:"clock", label:"Clock",          puzzle:"clock" },
    ];

    const eventSelect = document.getElementById('eventSelect');
    for (const ev of EVENTS){
      const opt = document.createElement('option');
      opt.value = ev.event;
      opt.textContent = ev.label;
      eventSelect.appendChild(opt);
    }
    eventSelect.value = "333";

    const scrambleText = document.getElementById('scrambleText');
    const scrambleStatus = document.getElementById('scrambleStatus');
    const player = document.getElementById('player');

    let lastScramble = "";
    let lastSolveAlg = "";

    function invertMove(m){
      if (!m) return m;
      if (m.endsWith("2")) return m;
      if (m.endsWith("'")) return m.slice(0,-1);
      return m + "'";
    }
    function inverseAlg(algStr){
      const toks = algStr.trim().split(/\\s+/).filter(Boolean);
      return toks.reverse().map(invertMove).join(" ");
    }
    function puzzleForEventId(eventId){
      return (EVENTS.find(e => e.event === eventId) || EVENTS[0]).puzzle;
    }

    async function generateScramble(){
      scrambleStatus.textContent = "Generating…";
      try{
        const eventId = eventSelect.value || "333";
        const alg = await randomScrambleForEvent(eventId);
        lastScramble = alg.toString();
        lastSolveAlg = inverseAlg(lastScramble);

        scrambleText.textContent = lastScramble;
        scrambleStatus.textContent = "WCA-style practice scramble";

        // Ensure puzzle + alg are set via properties
        player.puzzle = puzzleForEventId(eventId);
        player.alg = lastScramble;
        player.timestamp = 0;
        player.pause();
      }catch(err){
        console.error(err);
        scrambleText.textContent = "Scrambler failed to load. Check network and reload.";
        scrambleStatus.textContent = "Error";
      }
    }

    document.getElementById('newScrambleBtn').addEventListener('click', generateScramble);
    eventSelect.addEventListener('change', generateScramble);

    document.getElementById('copyScrambleBtn').addEventListener('click', async () => {
      const ok = await copyToClipboard(lastScramble || scrambleText.textContent.trim());
      alert(ok ? "Scramble copied." : "Could not copy.");
    });

    document.getElementById('playScrambleBtn').addEventListener('click', () => {
      if(!lastScramble) return;
      player.alg = lastScramble;
      player.timestamp = 0;
      player.play();
    });

    document.getElementById('solveReplayBtn').addEventListener('click', () => {
      if(!lastSolveAlg) return;
      player.alg = lastSolveAlg;
      player.timestamp = 0;
      player.play();
    });

    // ===== Timer/session (unchanged core behavior) =====
    const LS_SOLVES = 'bagdigital_cubing_solves_v4';
    let armed=false, running=false, startTime=0, raf=0;
    let solves=[];

    const timeDisplay=document.getElementById('timeDisplay');
    const statusText=document.getElementById('statusText');
    const sdot=document.querySelector('#statusPill .sdot');
    const ao5=document.getElementById('ao5');
    const ao12=document.getElementById('ao12');
    const chipsWrap=document.getElementById('solvesChips');

    function setStatus(text, mode){
      statusText.textContent=text;
      if(mode==='arm'){ sdot.style.background='var(--y)'; sdot.style.boxShadow='0 0 0 4px rgba(255,212,0,.18)'; return; }
      if(mode==='run'){ sdot.style.background='var(--r)'; sdot.style.boxShadow='0 0 0 4px rgba(230,27,35,.14)'; return; }
      if(mode==='stop'){ sdot.style.background='var(--g)'; sdot.style.boxShadow='0 0 0 4px rgba(0,176,80,.14)'; return; }
      sdot.style.background='var(--b)'; sdot.style.boxShadow='0 0 0 4px rgba(0,87,255,.14)';
    }
    function formatTime(ms){ return (ms/1000).toFixed(2); }
    function tick(){
      if(!running) return;
      timeDisplay.textContent = formatTime(performance.now()-startTime);
      raf = requestAnimationFrame(tick);
    }
    function averageTrimmed(arr){
      if(arr.length < 5) return null;
      const sorted=[...arr].sort((a,b)=>a-b);
      sorted.shift(); sorted.pop();
      return sorted.reduce((s,x)=>s+x,0)/sorted.length;
    }
    function computeStats(){
      const times=solves.map(s=>s.t);
      const v5=times.length>=5? averageTrimmed(times.slice(0,5)) : null;
      const v12=times.length>=12? averageTrimmed(times.slice(0,12)) : null;
      ao5.value = v5===null? '—' : v5.toFixed(2);
      ao12.value = v12===null? '—' : v12.toFixed(2);
    }
    function renderChips(){
      chipsWrap.innerHTML='';
      const recent=solves.slice(0,10);
      const pad = 10 - recent.length;
      recent.forEach((s,i)=>{
        const d=document.createElement('div');
        d.className='chip';
        d.innerHTML = `<span class="n">${i+1}</span><span class="t">${s.t.toFixed(2)}</span>`;
        chipsWrap.appendChild(d);
      });
      for(let i=0;i<pad;i++){
        const d=document.createElement('div');
        d.className='chip';
        d.innerHTML = `<span class="n">#</span><span class="t">—</span>`;
        chipsWrap.appendChild(d);
      }
    }
    function saveSolves(){ localStorage.setItem(LS_SOLVES, JSON.stringify(solves)); }
    function loadSolves(){
      try{
        const raw=localStorage.getItem(LS_SOLVES);
        solves = raw ? JSON.parse(raw) : [];
        if(!Array.isArray(solves)) solves=[];
      }catch(e){ solves=[]; }
      renderChips(); computeStats();
    }
    function addSolve(ms){
      solves.unshift({ t: ms/1000 });
      solves = solves.slice(0, 50);
      saveSolves(); renderChips(); computeStats();
    }
    document.addEventListener('keydown', (e)=>{
      if(e.code!=='Space') return;
      e.preventDefault();
      if(!running){
        if(!armed){ armed=true; setStatus('Hold… release to start','arm'); }
      }else{
        running=false; cancelAnimationFrame(raf);
        const elapsed=performance.now()-startTime;
        timeDisplay.textContent=formatTime(elapsed);
        setStatus('Stopped (saved)','stop');
        addSolve(elapsed);
      }
    }, { passive:false });
    document.addEventListener('keyup', (e)=>{
      if(e.code!=='Space') return;
      e.preventDefault();
      if(armed && !running){
        armed=false; running=true; startTime=performance.now();
        setStatus('Running… press Space to stop','run');
        tick();
      }else if(!running){
        armed=false; setStatus('Ready','ready');
      }
    }, { passive:false });

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      if(!confirm('Clear saved solves on this device?')) return;
      solves=[]; saveSolves(); renderChips(); computeStats();
      timeDisplay.textContent='0.00';
      setStatus('Ready','ready');
    });

    // Init
    loadSolves();
    document.getElementById('openWcaBtn').addEventListener('click', ()=>{});
    await generateScramble();
  </script>
</body>
</html>
